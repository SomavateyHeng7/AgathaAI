{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///Users/teyyyyyheng/Downloads/Archive%204/src/lib/database.ts"],"sourcesContent":["import { Pool, PoolConfig } from 'pg';\n\nconst poolConfig: PoolConfig = {\n  connectionString: process.env.DATABASE_URL,\n  min: parseInt(process.env.DATABASE_POOL_MIN || '2'),\n  max: parseInt(process.env.DATABASE_POOL_MAX || '10'),\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 2000,\n};\n\n// Create a singleton pool\nlet pool: Pool | null = null;\n\nfunction getPool() {\n  if (!pool) {\n    pool = new Pool(poolConfig);\n    \n    pool.on('error', (err) => {\n      console.error('Unexpected database error:', err);\n    });\n  }\n  \n  return pool;\n}\n\nexport async function query(text: string, params?: any[]) {\n  const pool = getPool();\n  const start = Date.now();\n  \n  try {\n    const res = await pool.query(text, params);\n    const duration = Date.now() - start;\n    \n    if (process.env.NODE_ENV === 'development') {\n      console.log('Executed query', { text: text.substring(0, 100), duration, rows: res.rowCount });\n    }\n    \n    return res;\n  } catch (error) {\n    console.error('Database query error:', error);\n    throw error;\n  }\n}\n\nexport async function getClient() {\n  const pool = getPool();\n  return await pool.connect();\n}\n\nexport async function testConnection() {\n  try {\n    const result = await query('SELECT NOW()');\n    console.log('✅ Database connected:', result.rows[0].now);\n    return true;\n  } catch (error) {\n    console.error('❌ Database connection failed:', error);\n    return false;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;;;;;AAEA,MAAM,aAAyB;IAC7B,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,SAAS,QAAQ,GAAG,CAAC,iBAAiB,IAAI;IAC/C,KAAK,SAAS,QAAQ,GAAG,CAAC,iBAAiB,IAAI;IAC/C,mBAAmB;IACnB,yBAAyB;AAC3B;AAEA,0BAA0B;AAC1B,IAAI,OAAoB;AAExB,SAAS;IACP,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qMAAI,CAAC;QAEhB,KAAK,EAAE,CAAC,SAAS,CAAC;YAChB,QAAQ,KAAK,CAAC,8BAA8B;QAC9C;IACF;IAEA,OAAO;AACT;AAEO,eAAe,MAAM,IAAY,EAAE,MAAc;IACtD,MAAM,OAAO;IACb,MAAM,QAAQ,KAAK,GAAG;IAEtB,IAAI;QACF,MAAM,MAAM,MAAM,KAAK,KAAK,CAAC,MAAM;QACnC,MAAM,WAAW,KAAK,GAAG,KAAK;QAE9B,wCAA4C;YAC1C,QAAQ,GAAG,CAAC,kBAAkB;gBAAE,MAAM,KAAK,SAAS,CAAC,GAAG;gBAAM;gBAAU,MAAM,IAAI,QAAQ;YAAC;QAC7F;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,MAAM;IACR;AACF;AAEO,eAAe;IACpB,MAAM,OAAO;IACb,OAAO,MAAM,KAAK,OAAO;AAC3B;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,SAAS,MAAM,MAAM;QAC3B,QAAQ,GAAG,CAAC,yBAAyB,OAAO,IAAI,CAAC,EAAE,CAAC,GAAG;QACvD,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO;IACT;AACF"}},
    {"offset": {"line": 180, "column": 0}, "map": {"version":3,"sources":["file:///Users/teyyyyyheng/Downloads/Archive%204/src/lib/auth-config.ts"],"sourcesContent":["import type { NextAuthOptions } from \"next-auth\";\nimport GoogleProvider from \"next-auth/providers/google\";\nimport CredentialsProvider from \"next-auth/providers/credentials\";\nimport { query } from \"./database\";\nimport bcrypt from \"bcrypt\";\n\nexport const authOptions: NextAuthOptions = {\n  providers: [\n    GoogleProvider({\n      clientId: process.env.GOOGLE_CLIENT_ID || \"\",\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET || \"\",\n    }),\n    CredentialsProvider({\n      name: \"Credentials\",\n      credentials: {\n        email: { label: \"Email\", type: \"email\" },\n        password: { label: \"Password\", type: \"password\" },\n      },\n      async authorize(credentials) {\n        if (!credentials?.email || !credentials?.password) {\n          return null;\n        }\n\n        try {\n          // Get user from database\n          const result = await query(\"SELECT * FROM users WHERE email = $1\", [\n            credentials.email as string,\n          ]);\n\n          if (result.rows.length === 0) {\n            return null;\n          }\n\n          const user = result.rows[0];\n\n          // Verify password\n          const isValid = await bcrypt.compare(\n            credentials.password as string,\n            user.password_hash,\n          );\n\n          if (!isValid) {\n            return null;\n          }\n\n          // Get user's API key\n          const apiKeyResult = await query(\n            \"SELECT key_hash FROM api_keys WHERE user_id = $1 AND status = 'active' LIMIT 1\",\n            [user.id],\n          );\n\n          return {\n            id: user.id,\n            email: user.email,\n            name: user.full_name,\n            tier: user.subscription_tier,\n            apiKey: apiKeyResult.rows[0]?.key_hash || null,\n          };\n        } catch (error) {\n          console.error(\"Auth error:\", error);\n          return null;\n        }\n      },\n    }),\n  ],\n  callbacks: {\n    async signIn({ user, account }) {\n      if (account?.provider === \"google\") {\n        try {\n          // Validate required fields from Google\n          if (!user.email) {\n            console.error(\n              \"Google sign-in error: Missing email from Google profile\",\n            );\n            return false;\n          }\n\n          // Check if user exists\n          const existingUser = await query(\n            \"SELECT * FROM users WHERE email = $1\",\n            [user.email],\n          );\n\n          if (existingUser.rows.length === 0) {\n            // Create new user\n            console.log(\"Creating new user:\", user.email);\n            const newUser = await query(\n              `INSERT INTO users (email, full_name, subscription_tier, email_verified, password_hash, created_at)\n               VALUES ($1, $2, $3, true, '', NOW())\n               RETURNING id`,\n              [user.email, user.name || user.email, \"free\"],\n            );\n\n            const userId = newUser.rows[0].id;\n            console.log(\"User created with ID:\", userId);\n\n            // Generate API key\n            const apiKey = `ak_${Math.random().toString(36).substring(2, 15)}${Math.random().toString(36).substring(2, 15)}`;\n            const keyHash = await bcrypt.hash(apiKey, 10);\n            const keyPrefix = apiKey.substring(0, 8);\n            const keySuffix = apiKey.substring(apiKey.length - 4);\n\n            await query(\n              `INSERT INTO api_keys (user_id, key_hash, key_prefix, key_suffix, name, created_at)\n               VALUES ($1, $2, $3, $4, $5, NOW())`,\n              [userId, keyHash, keyPrefix, keySuffix, \"Default API Key\"],\n            );\n\n            user.id = userId;\n          } else {\n            console.log(\"Existing user found:\", user.email);\n            user.id = existingUser.rows[0].id;\n          }\n\n          return true;\n        } catch (error) {\n          console.error(\"Google sign-in error:\", error);\n          console.error(\"Error details:\", JSON.stringify(error, null, 2));\n          return false;\n        }\n      }\n\n      return true;\n    },\n    async jwt({ token, user, account }) {\n      if (user) {\n        token.id = user.id;\n        token.tier = (user as any).tier;\n        token.apiKey = (user as any).apiKey;\n      }\n\n      if (account?.provider === \"google\" && token.email) {\n        // Get user data from database\n        const result = await query(\n          \"SELECT id, subscription_tier FROM users WHERE email = $1\",\n          [token.email],\n        );\n\n        if (result.rows.length > 0) {\n          token.id = result.rows[0].id;\n          token.tier = result.rows[0].subscription_tier;\n\n          // Get API key\n          const apiKeyResult = await query(\n            \"SELECT key_hash FROM api_keys WHERE user_id = $1 AND status = 'active' LIMIT 1\",\n            [result.rows[0].id],\n          );\n\n          token.apiKey = apiKeyResult.rows[0]?.key_hash || null;\n        }\n      }\n\n      return token;\n    },\n    async session({ session, token }) {\n      if (session.user) {\n        (session.user as any).id = token.id as string;\n        (session.user as any).tier = token.tier as string;\n        (session.user as any).apiKey = token.apiKey as string;\n      }\n      return session;\n    },\n  },\n  pages: {\n    signIn: \"/signin\",\n    signOut: \"/signin\",\n    error: \"/signin\",\n  },\n  session: {\n    strategy: \"jwt\",\n    maxAge: 30 * 24 * 60 * 60, // 30 days\n  },\n  secret: process.env.NEXTAUTH_SECRET,\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 352, "column": 0}, "map": {"version":3,"sources":["file:///Users/teyyyyyheng/Downloads/Archive%204/src/app/api/chat/conversations/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth-config\";\nimport { query } from \"@/lib/database\";\n\n// GET /api/chat/conversations - List all conversations for the user\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getServerSession(authOptions);\n\n    if (!session || !session.user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const userId = (session.user as any).id;\n\n    const result = await query(\n      `SELECT id, title, model, message_count, total_tokens, created_at, updated_at\n       FROM conversations\n       WHERE user_id = $1\n       ORDER BY updated_at DESC\n       LIMIT 50`,\n      [userId],\n    );\n\n    return NextResponse.json({ conversations: result.rows });\n  } catch (error: any) {\n    console.error(\"Get conversations error:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch conversations\" },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;;;;;;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,UAAU,MAAM,IAAA,yXAAgB,EAAC,6IAAW;QAElD,IAAI,CAAC,WAAW,CAAC,QAAQ,IAAI,EAAE;YAC7B,OAAO,iTAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,SAAS,AAAC,QAAQ,IAAI,CAAS,EAAE;QAEvC,MAAM,SAAS,MAAM,IAAA,iIAAK,EACxB,CAAC;;;;eAIQ,CAAC,EACV;YAAC;SAAO;QAGV,OAAO,iTAAY,CAAC,IAAI,CAAC;YAAE,eAAe,OAAO,IAAI;QAAC;IACxD,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,iTAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAgC,GACzC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}